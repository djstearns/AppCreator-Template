function Migrator(e,t){this.db=t,this.dbname=e.adapter.db_name,this.table=e.adapter.collection_name,this.idAttribute=e.adapter.idAttribute,this.column=function(e){var t=e.split(/\s+/),i=t[0];switch(i.toLowerCase()){case"string":case"varchar":case"date":case"datetime":Ti.API.warn('"'+i+'" is not a valid sqlite field, using TEXT instead');case"text":i="TEXT";break;case"int":case"tinyint":case"smallint":case"bigint":case"boolean":Ti.API.warn('"'+i+'" is not a valid sqlite field, using INTEGER instead');case"integer":i="INTEGER";break;case"double":case"float":case"decimal":case"number":Ti.API.warn('"'+e+'" is not a valid sqlite field, using REAL instead');case"real":i="REAL";break;case"blob":i="BLOB";break;case"null":i="NULL";break;default:i="TEXT"}return t[0]=i,t.join(" ")},this.createTable=function(e){var t=[],i=!1;for(var o in e.columns)o===this.idAttribute&&(i=!0),t.push(o+" "+this.column(e.columns[o]));i||this.idAttribute!==ALLOY_ID_DEFAULT||t.push(ALLOY_ID_DEFAULT+" TEXT UNIQUE");var r="CREATE TABLE IF NOT EXISTS "+this.table+" ( "+t.join(",")+")";this.db.execute(r)},this.dropTable=function(){this.db.execute("DROP TABLE IF EXISTS "+this.table)},this.insertRow=function(e){var t=[],i=[],o=[],r=!1;for(var a in e)a===this.idAttribute&&(r=!0),t.push(a),i.push(e[a]),o.push("?");r||this.idAttribute!==ALLOY_ID_DEFAULT||(t.push(this.idAttribute),i.push(util.guid()),o.push("?")),this.db.execute("INSERT INTO "+this.table+" ("+t.join(",")+") VALUES ("+o.join(",")+");",i)},this.deleteRow=function(e){var t="DELETE FROM "+this.table,i=_.keys(e),o=i.length,r=[],a=[];o&&(t+=" WHERE ");for(var n=0;o>n;n++)r.push(i[n]+" = ?"),a.push(e[i[n]]);t+=r.join(" AND "),this.db.execute(t,a)}}function Sync(e,t,i){var o,r=t.config.adapter.collection_name,a=t.config.columns,n=t.config.adapter.db_name||ALLOY_DB_DEFAULT,l=null;switch(e){case"create":case"update":l=function(){var e={};t.id||(t.id=t.idAttribute===ALLOY_ID_DEFAULT?util.guid():null,e[t.idAttribute]=t.id,t.set(e,{silent:!0}));var i=[],l=[],s=[];for(var d in a)i.push(d),l.push(t.get(d)),s.push("?");var c="REPLACE INTO "+r+" ("+i.join(",")+") VALUES ("+s.join(",")+");";if(o=Ti.Database.open(n),o.execute("BEGIN;"),o.execute(c,l),null===t.id){var _="SELECT last_insert_rowid();",u=o.execute(_);u&&u.isValidRow()?(t.id=u.field(0),e[t.idAttribute]=t.id,t.set(e,{silent:!0})):Ti.API.warn("Unable to get ID from database for model: "+t.toJSON()),u&&u.close()}return o.execute("COMMIT;"),o.close(),t.toJSON()}();break;case"read":var s=i.query||"SELECT * FROM "+r;o=Ti.Database.open(n);var d;d=_.isString(s)?o.execute(s):o.execute(s.statement,s.params);for(var c=0,u=[];d.isValidRow();){var h={},y=0;y=_.isFunction(d.fieldCount)?d.fieldCount():d.fieldCount,_.times(y,function(e){var t=d.fieldName(e);h[t]=d.fieldByName(t)}),u.push(h),c++,d.next()}d.close(),o.close(),t.length=c,l=1===c?u[0]:u;break;case"delete":var s="DELETE FROM "+r+" WHERE "+t.idAttribute+"=?";o=Ti.Database.open(n),o.execute(s,t.id),o.close(),t.id=null,l=t.toJSON()}l?(_.isFunction(i.success)&&i.success(l),"read"===e&&t.trigger("fetch")):_.isFunction(i.error)&&i.error(l)}function GetMigrationFor(e,t){var i=null,o=Ti.Database.open(e);o.execute("CREATE TABLE IF NOT EXISTS migrations (latest TEXT, model TEXT);");var r=o.execute("SELECT latest FROM migrations where model = ?;",t);if(r.isValidRow())var i=r.field(0)+"";return r.close(),o.close(),i}function Migrate(e){var t=e.migrations||[],i={};t.length&&t[t.length-1](i);var o=e.prototype.config;o.adapter.db_name||(o.adapter.db_name=ALLOY_DB_DEFAULT);var r=new Migrator(o),a=o.adapter.migration===void 0||null===o.adapter.migration?i.id:o.adapter.migration;if(a===void 0||null===a){var n=Ti.Database.open(o.adapter.db_name);return r.db=n,r.createTable(o),n.close(),void 0}a+="";var l,s=GetMigrationFor(o.adapter.db_name,o.adapter.collection_name);if(s!==a){if(s&&s>a?(l=0,t.reverse()):l=1,db=Ti.Database.open(o.adapter.db_name),r.db=db,db.execute("BEGIN;"),t.length)for(var d=0;t.length>d;d++){var c=t[d],u={};if(c(u),l){if(u.id>a)break;if(s>=u.id)continue}else{if(a>=u.id)break;if(u.id>s)continue}var h=l?"up":"down";_.isFunction(u[h])&&u[h](r)}else r.createTable(o);db.execute("DELETE FROM migrations where model = ?",o.adapter.collection_name),db.execute("INSERT INTO migrations VALUES (?,?)",a,o.adapter.collection_name),db.execute("COMMIT;"),db.close(),r.db=null}}function installDatabase(e){var t=e.adapter.db_file,i=e.adapter.collection_name,o=/(^|.*\/)([^\/]+)\.[^\/]+$/,r=t.match(o);if(null===r)throw'Invalid sql database filename "'+t+'"';e.adapter.db_name=e.adapter.db_name||r[2];var a=e.adapter.db_name;Ti.API.debug('Installing sql database "'+t+'" with name "'+a+'"');var n=Ti.Database.install(t,a);!1===e.adapter.remoteBackup&&(Ti.API.debug('iCloud "do not backup" flag set for database "'+t+'"'),n.file.setRemoteBackup(!1));for(var l=n.execute('pragma table_info("'+i+'");'),s={};l.isValidRow();){var d=l.fieldByName("name"),c=l.fieldByName("type");s[d]=c,d!==ALLOY_ID_DEFAULT||e.adapter.idAttribute||(e.adapter.idAttribute=ALLOY_ID_DEFAULT),l.next()}if(e.columns=s,l.close(),e.adapter.idAttribute){if(!_.contains(_.keys(e.columns),e.adapter.idAttribute))throw'config.adapter.idAttribute "'+e.adapter.idAttribute+'" not found in list of columns for table "'+i+'"\n'+"columns: ["+_.keys(e.columns).join(",")+"]"}else{Ti.API.info('No config.adapter.idAttribute specified for table "'+i+'"'),Ti.API.info('Adding "'+ALLOY_ID_DEFAULT+'" to uniquely identify rows');var u=[],h=[];_.each(e.columns,function(e,t){h.push(t),u.push(t+" "+e)});var y=h.join(",");n.execute("ALTER TABLE "+i+" RENAME TO "+i+"_temp;"),n.execute("CREATE TABLE "+i+"("+u.join(",")+","+ALLOY_ID_DEFAULT+" TEXT UNIQUE);"),n.execute("INSERT INTO "+i+"("+y+","+ALLOY_ID_DEFAULT+") SELECT "+y+",CAST(_ROWID_ AS TEXT) FROM "+i+"_temp;"),n.execute("DROP TABLE "+i+"_temp;"),e.columns[ALLOY_ID_DEFAULT]="TEXT UNIQUE",e.adapter.idAttribute=ALLOY_ID_DEFAULT}n.close()}var _=require("alloy/underscore")._,util=require("alloy/sync/util"),ALLOY_DB_DEFAULT="_alloy_",ALLOY_ID_DEFAULT="alloy_id",cache={config:{},Model:{}};module.exports.beforeModelCreate=function(e,t){if(cache.config[t])return cache.config[t];if("mobileweb"===Ti.Platform.osname||Ti.Database===void 0)throw"No support for Ti.Database in MobileWeb environment.";return e.adapter.db_file&&installDatabase(e),e.adapter.idAttribute||(Ti.API.info('No config.adapter.idAttribute specified for table "'+e.adapter.collection_name+'"'),Ti.API.info('Adding "'+ALLOY_ID_DEFAULT+'" to uniquely identify rows'),e.columns[ALLOY_ID_DEFAULT]="TEXT UNIQUE",e.adapter.idAttribute=ALLOY_ID_DEFAULT),cache.config[t]=e,e},module.exports.afterModelCreate=function(e,t){return cache.Model[t]?cache.Model[t]:(e||(e={}),e.prototype.idAttribute=e.prototype.config.adapter.idAttribute,Migrate(e),cache.Model[t]=e,e)},module.exports.sync=Sync;